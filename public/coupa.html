<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAESTRO | Coupa Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="pagina-painel" onload="inicializarPainel()">

    <div class="container">
        
        <div class="header">
            <div class="header-title-box">
                <img src="logo-maestro.jpg" alt="Logo MAESTRO Mini" class="header-logo-mini">
                <div>
                    <h1>Dashboard <span>Coupa</span></h1>
                    <div style="color: var(--text-dim); font-family: 'Roboto Mono', monospace; font-size: 11px; margin-top: 4px;">WORKSPACE // AMBIENTE PROTEGIDO</div>
                </div>
            </div>
            
            <div class="header-toolbar">
                <div id="badge-fila" class="badge">FILA: 0</div>
                <a href="index.html" class="btn-voltar" style="margin-bottom: 0;"><i class="fa-solid fa-right-from-bracket"></i> Desconectar</a>
            </div>
        </div>
        
        <div class="dashboard-grid">
            
            <div class="col-side">
                <div class="glass-card" style="margin-bottom: 25px;">
                    <h3 class="card-title"><i class="fa-solid fa-server"></i> Controle de Conex√£o</h3>
                    <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 20px; line-height: 1.5;">Estabele√ßa uma conex√£o segura com o servidor Python local para liberar os m√≥dulos operacionais.</p>
                    
                    <button id="btn-ligar" onclick="ligarRobo()" class="btn btn-large btn-power">
                        <i class="fa-solid fa-power-off"></i> Iniciar Servidor
                    </button>
                </div>

                <div class="glass-card">
                    <h3 class="card-title"><i class="fa-solid fa-microchip"></i> Status do Sistema</h3>
                    <div class="sys-info-row">
                        <span class="sys-label">Ambiente</span>
                        <span class="sys-value" style="color: var(--accent-blue);">PRODU√á√ÉO</span>
                    </div>
                    <div class="sys-info-row">
                        <span class="sys-label">Portal Alvo</span>
                        <span class="sys-value">Coupa Vale S.A.</span>
                    </div>
                    <div class="sys-info-row">
                        <span class="sys-label">Fila Atual</span>
                        <span class="sys-value" id="info-fila">0 Processos</span>
                    </div>
                    <div class="sys-info-row" style="border: none; margin-bottom: 0;">
                        <span class="sys-label">Sincroniza√ß√£o</span>
                        <span class="sys-value" id="info-sync">Aguardando...</span>
                    </div>
                </div>
            </div>

            <div class="col-main">
                <div class="glass-card" style="min-height: 300px;">
                    
                    <div id="overlay-lock" class="lock-screen">
                        <i class="fa-solid fa-lock"></i>
                        <h3>M√≥dulo Bloqueado</h3>
                        <p>Aguardando autentica√ß√£o do servidor...</p>
                    </div>

                    <h3 id="txt-status" class="card-title" style="color: var(--text-main);">
                        <i class="fa-solid fa-terminal"></i> M√ìDULOS DE AUTOMA√á√ÉO
                    </h3>
                    
                    <div class="botoes-acao" style="margin-top: 25px;">
                        <button id="btn-extrair" class="btn btn-extract"><i class="fa-solid fa-download"></i> Extrair Cota√ß√µes</button>
                        <button id="btn-verificar" class="btn btn-verify"><i class="fa-solid fa-check-double"></i> Verificar Dados</button>
                        <button id="btn-abrir-res" class="btn btn-respond"><i class="fa-solid fa-bolt"></i> Responder Eventos</button>
                    </div>
                    
                    <div id="area-resposta" class="form-container">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h3 class="card-title" style="color: #fff; margin: 0; border: none;"><i class="fa-solid fa-layer-group"></i> PACOTES DE TRANSMISS√ÉO</h3>
                            <button type="button" onclick="adicionarBlocoEvento()" class="btn btn-extract" style="padding: 10px 15px; font-size: 11px; margin: 0;"><i class="fa-solid fa-plus"></i> ADICIONAR EVENTO</button>
                        </div>
                        
                        <form id="formResponder">
                            <div id="container-eventos"></div>

                            <button type="button" onclick="enviarRespostasEmLote()" class="btn btn-large btn-respond" style="margin-top: 15px;">
                                <i class="fa-solid fa-server"></i> ENVIAR TUDO PARA A FILA
                            </button>
                        </form>
                    </div>
                </div>

                <div id="painel-progresso" class="glass-card" style="display: none; margin-top: 25px;">
                    <h3 class="card-title"><i class="fa-solid fa-network-wired"></i> MONITOR DE PROCESSOS</h3>
                    <div class="status-grid">
                        <div class="status-box">
                            <h4><i class="fa-solid fa-clock"></i> NA FILA</h4>
                            <ul id="lista-pendentes"></ul>
                        </div>
                        <div class="status-box">
                            <h4><i class="fa-solid fa-check-double" style="color: var(--vale-green)"></i> FINALIZADOS</h4>
                            <ul id="lista-concluidos"></ul>
                        </div>
                    </div>
                </div>
                
                <div id="area-captcha" class="glass-card">
                    <h3 class="card-title" style="color: var(--alert-red);"><i class="fa-solid fa-shield-halved"></i> INTERVEN√á√ÉO DE SEGURAN√áA</h3>
                    <p style="margin: 0; color: var(--text-main); font-family: 'Roboto Mono', monospace; font-size: 12px; line-height: 1.6;">> O sistema da Vale bloqueou a automa√ß√£o temporariamente. Clique na imagem abaixo para resolver o desafio e liberar o fluxo:</p>
                    <img id="imagem-captcha" src="" alt="Tela Captcha">
                </div>

            </div>
        </div>
    </div>

    <div class="barra-status">
        <div id="indicador-status" class="status-dot offline"></div>
        <span id="log">Conectando ao n√∫cleo maestro...</span>
    </div>

    <script>
        const socket = io();
        socket.emit('sou_frontend'); 
        
        let timerCaptcha; 
        let contadorEventos = 0;
        let arquivosPorEvento = {};

        function inicializarPainel() {
            adicionarBlocoEvento();
        }

        socket.on('sincronizar_estado', function(dados) {
            const estado = dados.estado;
            const msg = dados.mensagem;
            
            const dot = document.getElementById('indicador-status');
            if (estado.status === 'desligado' || !msg) { dot.classList.add('offline'); } 
            else { dot.classList.remove('offline'); }
            
            if (msg) document.getElementById('log').innerText = `> ${msg}`;

            document.getElementById('info-fila').innerText = `${estado.tamanho_fila} Processos`;
            const dataHora = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('info-sync').innerText = `Hoje √†s ${dataHora}`;

            const painelProgresso = document.getElementById('painel-progresso');
            if (estado.fila_pendente.length > 0 || estado.historico_respondidos.length > 0) {
                painelProgresso.style.display = 'block';
                
                // NOVO: Renderiza a fila pendente COM o bot√£o de X para remover
                document.getElementById('lista-pendentes').innerHTML = estado.fila_pendente.map(e => `
                    <li style="display: flex; justify-content: space-between; align-items: center; padding-right: 5px;">
                        <span><i class="fa-solid fa-spinner fa-spin" style="color:var(--text-dim); margin-right: 8px;"></i> EVT_${e}</span>
                        <button class="btn-remover-fila" onclick="removerDaFila('${e}')" title="Cancelar este envio"><i class="fa-solid fa-xmark"></i></button>
                    </li>
                `).join('');
                
                document.getElementById('lista-concluidos').innerHTML = estado.historico_respondidos.map(e => {
                    if(e.includes('Falhou')) return `<li style="color:var(--alert-red)"><i class="fa-solid fa-xmark"></i> ${e}</li>`;
                    return `<li><i class="fa-solid fa-check" style="color:var(--vale-green)"></i> EVT_${e}</li>`;
                }).join('');
            } else { painelProgresso.style.display = 'none'; }

            if (estado.status === 'ocioso' || estado.status === 'desligado') {
                document.getElementById('area-captcha').style.display = 'none';
            }

            const btnLigar = document.getElementById('btn-ligar');
            const txtStatus = document.getElementById('txt-status');
            const overlayLock = document.getElementById('overlay-lock');
            
            const btnExtrair = document.getElementById('btn-extrair');
            const btnVerificar = document.getElementById('btn-verificar');
            const btnAbrirRes = document.getElementById('btn-abrir-res');
            
            btnExtrair.className = 'btn btn-extract';
            btnExtrair.innerHTML = '<i class="fa-solid fa-download"></i> Extrair Cota√ß√µes';
            btnExtrair.disabled = false;
            btnExtrair.onclick = function() { executarTarefa('extrair'); };

            btnVerificar.className = 'btn btn-verify';
            btnVerificar.innerHTML = '<i class="fa-solid fa-check-double"></i> Verificar Dados';
            btnVerificar.disabled = false;
            btnVerificar.onclick = function() { executarTarefa('verificar'); };

            btnAbrirRes.className = 'btn btn-respond';
            btnAbrirRes.innerHTML = '<i class="fa-solid fa-bolt"></i> Responder Eventos';
            btnAbrirRes.disabled = false;
            btnAbrirRes.onclick = function() { mostrarFormResposta(); };

            if (estado.status === 'desligado') {
                btnLigar.disabled = false; 
                btnLigar.classList.remove('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-power-off"></i> INICIAR SERVIDOR';
                overlayLock.style.opacity = '1';
                overlayLock.style.pointerEvents = 'all';
                overlayLock.innerHTML = '<i class="fa-solid fa-lock"></i><h3>M√≥dulo Bloqueado</h3><p>Aguardando autentica√ß√£o do servidor...</p>';
            } else if (estado.status === 'logando') {
                btnLigar.disabled = true; 
                btnLigar.classList.remove('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> AUTENTICANDO...';
                overlayLock.innerHTML = '<i class="fa-solid fa-fingerprint fa-bounce" style="color:var(--accent-blue)"></i><h3 style="color:var(--accent-blue)">Autenticando</h3><p>Validando credenciais de acesso...</p>';
            } else {
                btnLigar.disabled = true; 
                btnLigar.classList.add('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-link"></i> SISTEMA ONLINE';
                
                overlayLock.style.opacity = '0';
                setTimeout(() => { overlayLock.style.pointerEvents = 'none'; }, 500);
                
                if (estado.status === 'ocioso') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-terminal"></i> STATUS: AGUARDANDO COMANDOS';
                    txtStatus.style.color = 'var(--vale-green)';
                
                } else if (estado.status === 'extraindo' || estado.status === 'extrair') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> ALGU√âM EST√Å EXTRAINDO DADOS...';
                    txtStatus.style.color = 'var(--vale-yellow)';
                    btnExtrair.className = 'btn btn-stop';
                    btnExtrair.innerHTML = '<i class="fa-solid fa-hand"></i> PARAR EXTRA√á√ÉO';
                    btnExtrair.onclick = function() { solicitarParada(this); };
                    btnVerificar.disabled = true;
                    btnAbrirRes.disabled = true;
                    document.getElementById('area-resposta').style.display = 'none';
                
                } else if (estado.status === 'verificando' || estado.status === 'verificar') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> ALGU√âM EST√Å VERIFICANDO DADOS...';
                    txtStatus.style.color = 'var(--accent-blue)';
                    btnVerificar.className = 'btn btn-stop';
                    btnVerificar.innerHTML = '<i class="fa-solid fa-hand"></i> PARAR VERIFICA√á√ÉO';
                    btnVerificar.onclick = function() { solicitarParada(this); };
                    btnExtrair.disabled = true;
                    btnAbrirRes.disabled = true;
                    document.getElementById('area-resposta').style.display = 'none';
                
                } else if (estado.status === 'respondendo') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-database"></i> SISTEMA GRAVANDO RESPOSTAS NA NUVEM...';
                    txtStatus.style.color = 'var(--accent-blue)';
                    btnExtrair.disabled = true;
                    btnVerificar.disabled = true; 
                }
            }
        });

        socket.on('nova_imagem', function(dados) { 
            const areaCaptcha = document.getElementById('area-captcha');
            areaCaptcha.style.display = 'block';
            document.getElementById('imagem-captcha').src = "data:image/png;base64," + dados.imagem; 
            window.scrollTo({ top: areaCaptcha.offsetTop - 20, behavior: 'smooth' });

            clearTimeout(timerCaptcha);
            timerCaptcha = setTimeout(() => { areaCaptcha.style.display = 'none'; }, 5000);
        });

        document.getElementById('imagem-captcha').addEventListener('click', function(event) {
            const rect = this.getBoundingClientRect();
            socket.emit('clique_no_captcha', { x: Math.round(event.offsetX * (this.naturalWidth / rect.width)), y: Math.round(event.offsetY * (this.naturalHeight / rect.height)) });
            document.getElementById('area-captcha').style.display = 'none';
        });

        function ligarRobo() { socket.emit('comando_direto', { modo: 'ligar_robo' }); }
        function executarTarefa(modo) { socket.emit('comando_direto', { modo: modo }); }
        function solicitarParada(btnElement) { 
            socket.emit('comando_direto', { modo: 'solicitar_parada' }); 
            if(btnElement) {
                btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> FOR√áANDO PARADA...'; 
                btnElement.disabled = true; 
            }
        }
        function mostrarFormResposta() { document.getElementById('area-resposta').style.display = 'block'; }

        // === NOVA FUN√á√ÉO: REMOVER EVENTO DA FILA ===
        function removerDaFila(eventoId) {
            if(confirm(`üö® Aten√ß√£o: Tem certeza que deseja cancelar e remover o Evento ${eventoId} da fila de respostas?`)) {
                socket.emit('remover_da_fila', { evento: eventoId });
            }
        }

        // ==========================================
        // ACORDE√ÉO E BLOCOS DE EVENTOS
        // ==========================================
        
        function adicionarBlocoEvento() {
            contadorEventos++;
            const id = contadorEventos;
            arquivosPorEvento[id] = { ds: [], dav: [] };

            const blocosAbertos = document.querySelectorAll('.evento-body.active');
            blocosAbertos.forEach(corpo => {
                const header = corpo.previousElementSibling;
                const icone = header.querySelector('.toggle-icon');
                corpo.classList.remove('active');
                header.classList.remove('active');
                icone.classList.remove('fa-chevron-up');
                icone.classList.add('fa-chevron-down');
            });

            const div = document.createElement('div');
            div.className = 'evento-card';
            div.id = `bloco_evento_${id}`;
            
            div.innerHTML = `
                <div class="evento-header active" onclick="toggleBlocoEvento(${id}, event)">
                    <div class="evento-title"><i class="fa-solid fa-box-archive"></i> EVENTO <span id="titulo_evento_${id}" style="color: #fff; margin-left: 5px;">#NOVO</span></div>
                    <div class="evento-actions">
                        ${id > 1 ? `<button type="button" class="btn-mini-action danger" onclick="removerBlocoEvento(${id}, event)" title="Excluir Bloco"><i class="fa-solid fa-trash"></i></button>` : ''}
                        <i class="fa-solid fa-chevron-up toggle-icon" id="icone_toggle_${id}" style="color: var(--text-dim); margin-left: 10px;"></i>
                    </div>
                </div>
                
                <div class="evento-body active" id="corpo_evento_${id}">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>N¬∫ DO EVENTO Espec√≠fico</label>
                            <input type="text" id="res_evento_${id}" placeholder="Ex: 165060" oninput="atualizarTituloEvento(${id})" required>
                        </div>
                        <div class="form-group">
                            <label>QTD. M√ÅXIMA DE ITENS DESTE EVENTO</label>
                            <input type="number" id="res_qtd_itens_${id}" min="1" value="1" onchange="gerarCamposItensBloco(${id})">
                        </div>
                    </div>
                    
                    <div id="container-itens-${id}"></div>

                    <div class="grid-2" style="margin-top: 20px; padding-top: 20px; border-top: 1px dashed var(--border-glass);">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label><i class="fa-solid fa-paperclip" style="color: var(--alert-red)"></i> DATASHEET (.PDF)</label>
                            <input type="file" accept=".pdf" multiple onchange="adicionarArquivosBloco(event, 'ds', ${id})">
                            <div id="lista-ds-${id}" style="margin-top: 10px;"></div>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label><i class="fa-solid fa-paperclip" style="color: var(--alert-red)"></i> DAV (.PDF)</label>
                            <input type="file" accept=".pdf" multiple onchange="adicionarArquivosBloco(event, 'dav', ${id})">
                            <div id="lista-dav-${id}" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('container-eventos').appendChild(div);
            gerarCamposItensBloco(id); 
        }

        function toggleBlocoEvento(id, event) {
            if(event && event.target.closest('.danger')) return; 
            
            const corpo = document.getElementById(`corpo_evento_${id}`);
            const icone = document.getElementById(`icone_toggle_${id}`);
            const header = corpo.previousElementSibling;
            
            if (corpo.classList.contains('active')) {
                corpo.classList.remove('active');
                header.classList.remove('active');
                icone.classList.remove('fa-chevron-up');
                icone.classList.add('fa-chevron-down');
            } else {
                corpo.classList.add('active');
                header.classList.add('active');
                icone.classList.remove('fa-chevron-down');
                icone.classList.add('fa-chevron-up');
            }
        }

        function removerBlocoEvento(id, event) {
            if(event) event.stopPropagation();
            document.getElementById(`bloco_evento_${id}`).remove();
            delete arquivosPorEvento[id]; 
        }

        function atualizarTituloEvento(id) {
            const val = document.getElementById(`res_evento_${id}`).value;
            document.getElementById(`titulo_evento_${id}`).innerText = val ? `#${val}` : '#NOVO';
        }

        function gerarCamposItensBloco(id) {
            const qtd = parseInt(document.getElementById(`res_qtd_itens_${id}`).value) || 1;
            const container = document.getElementById(`container-itens-${id}`);
            container.innerHTML = ''; 
            for(let i=1; i<=qtd; i++) {
                container.innerHTML += `
                    <div class="caixa-item">
                        <span class="caixa-item-titulo">[ ITEM_0${i} ]</span>
                        <div class="grid-2">
                            <div class="form-group" style="margin: 0;">
                                <label>VALOR UNIT√ÅRIO (R$)</label>
                                <input type="text" id="res_preco_${id}_${i}" placeholder="0,00">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>PRAZO (DIAS)</label>
                                <input type="number" id="res_prazo_${id}_${i}" placeholder="0">
                            </div>
                        </div>
                    </div>`;
            }
        }

        function adicionarArquivosBloco(event, tipo, id) {
            const files = event.target.files;
            for(let i = 0; i < files.length; i++) {
                arquivosPorEvento[id][tipo].push(files[i]);
            }
            event.target.value = ""; 
            atualizarListasNaTelaBloco(tipo, id);
        }

        function removerArquivoBloco(tipo, index, id) {
            arquivosPorEvento[id][tipo].splice(index, 1);
            atualizarListasNaTelaBloco(tipo, id);
        }

        function atualizarListasNaTelaBloco(tipo, id) {
            const div = document.getElementById(`lista-${tipo}-${id}`);
            const lista = arquivosPorEvento[id][tipo];
            div.innerHTML = "";
            lista.forEach((arquivo, index) => {
                div.innerHTML += `
                    <div class="arquivo-item" style="padding: 5px 10px;">
                        <span><i class="fa-regular fa-file" style="color:var(--text-dim);"></i> ${arquivo.name}</span> 
                        <button type="button" class="btn-remover" onclick="removerArquivoBloco('${tipo}', ${index}, ${id})"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
        }

        async function enviarRespostasEmLote() {
            const blocos = document.querySelectorAll('.evento-card');
            if(blocos.length === 0) return;

            const btnEnviar = document.querySelector('button[onclick="enviarRespostasEmLote()"]');
            const textoOriginal = btnEnviar.innerHTML;
            btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> TRANSMITINDO PACOTES...';
            btnEnviar.disabled = true;

            for (const bloco of blocos) {
                const idStr = bloco.id.split('_')[2];
                const id = parseInt(idStr);

                const eventoId = document.getElementById(`res_evento_${id}`).value;
                if(!eventoId) continue; 

                const qtd = parseInt(document.getElementById(`res_qtd_itens_${id}`).value) || 1;
                let precos = []; let prazos = [];
                
                for(let i=1; i<=qtd; i++) {
                    precos.push(document.getElementById(`res_preco_${id}_${i}`).value);
                    prazos.push(document.getElementById(`res_prazo_${id}_${i}`).value);
                }

                const formData = new FormData();
                formData.append('evento', eventoId);
                formData.append('precos', JSON.stringify(precos));
                formData.append('prazos', JSON.stringify(prazos));
                
                const filesDS = arquivosPorEvento[id]['ds'];
                const filesDAV = arquivosPorEvento[id]['dav'];

                for(let i=0; i < filesDS.length; i++) { formData.append('datasheet', filesDS[i]); }
                for(let i=0; i < filesDAV.length; i++) { formData.append('dav', filesDAV[i]); }

                try { await fetch('/api/responder', { method: 'POST', body: formData }); } 
                catch(err) { console.error("Falha ao transmitir o evento: " + eventoId); }
            }

            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
            document.getElementById('area-resposta').style.display = 'none';
            
            document.getElementById('container-eventos').innerHTML = '';
            contadorEventos = 0;
            arquivosPorEvento = {};
            adicionarBlocoEvento(); 

            window.scrollTo({ top: document.getElementById('painel-progresso').offsetTop - 20, behavior: 'smooth' });
        }
    </script>
</body>
</html>