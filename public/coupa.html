<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAESTRO | Coupa Enterprise</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="pagina-painel" onload="gerarCamposItens()">

    <div id="particles-js"></div>

    <div class="container">
        
        <div class="header">
            <div class="header-title-box">
                <img src="CÓDIGO_BASE64_AQUI" alt="Logo MAESTRO Mini" class="header-logo-mini">
                <div>
                    <h1>Terminal <span>Coupa</span></h1>
                    <div style="color: var(--text-dim); font-family: 'Roboto Mono', monospace; font-size: 11px; margin-top: 4px;">WORKSPACE // AMBIENTE PROTEGIDO</div>
                </div>
            </div>
            
            <div class="header-toolbar">
                <div id="badge-fila" class="badge">FILA: 0</div>
                <a href="index.html" class="btn-voltar" style="margin-bottom: 0;"><i class="fa-solid fa-right-from-bracket"></i> Desconectar</a>
            </div>
        </div>
        
        <div class="dashboard-grid">
            
            <div class="col-side">
                <div class="glass-card" style="margin-bottom: 25px;">
                    <h3 class="card-title"><i class="fa-solid fa-server"></i> Controle de Conexão</h3>
                    <p style="font-size: 12px; color: var(--text-dim); margin-bottom: 20px; line-height: 1.5;">Estabeleça uma conexão segura com o servidor Python local para liberar os módulos operacionais.</p>
                    
                    <button id="btn-ligar" onclick="ligarRobo()" class="btn btn-large btn-power">
                        <i class="fa-solid fa-power-off"></i> Iniciar Servidor
                    </button>
                </div>

                <div class="glass-card">
                    <h3 class="card-title"><i class="fa-solid fa-microchip"></i> Status do Sistema</h3>
                    <div class="sys-info-row">
                        <span class="sys-label">Ambiente</span>
                        <span class="sys-value" style="color: var(--accent-blue);">PRODUÇÃO</span>
                    </div>
                    <div class="sys-info-row">
                        <span class="sys-label">Portal Alvo</span>
                        <span class="sys-value">Coupa Vale S.A.</span>
                    </div>
                    <div class="sys-info-row">
                        <span class="sys-label">Fila Atual</span>
                        <span class="sys-value" id="info-fila">0 Processos</span>
                    </div>
                    <div class="sys-info-row" style="border: none; margin-bottom: 0;">
                        <span class="sys-label">Sincronização</span>
                        <span class="sys-value" id="info-sync">Aguardando...</span>
                    </div>
                </div>
            </div>

            <div class="col-main">
                <div class="glass-card" style="min-height: 300px;">
                    
                    <div id="overlay-lock" class="lock-screen">
                        <i class="fa-solid fa-lock"></i>
                        <h3>Módulo Bloqueado</h3>
                        <p>Aguardando autenticação do servidor...</p>
                    </div>

                    <h3 id="txt-status" class="card-title" style="color: var(--text-main);">
                        <i class="fa-solid fa-terminal"></i> MÓDULOS DE AUTOMAÇÃO
                    </h3>
                    
                    <div class="botoes-acao" style="margin-top: 25px;">
                        <button id="btn-extrair" class="btn btn-extract"><i class="fa-solid fa-download"></i> Extrair Cotações</button>
                        <button id="btn-verificar" class="btn btn-verify"><i class="fa-solid fa-check-double"></i> Verificar Dados</button>
                        <button id="btn-abrir-res" class="btn btn-respond"><i class="fa-solid fa-bolt"></i> Responder Eventos</button>
                    </div>
                    
                    <div id="area-resposta" class="form-container">
                        <h3 class="card-title" style="color: #fff; margin-bottom: 25px; border-bottom: none;"><i class="fa-solid fa-code-commit"></i> PACOTE DE TRANSMISSÃO</h3>
                        
                        <form id="formResponder">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label>Nº DO EVENTO (Separar por vírgula)</label>
                                    <input type="text" id="res_evento" required placeholder="Ex: 165060, 165061">
                                </div>
                                <div class="form-group">
                                    <label>QTD. DE ITENS NA TELA</label>
                                    <input type="number" id="res_qtd_itens" min="1" value="1" required onchange="gerarCamposItens()">
                                </div>
                            </div>
                            
                            <p style="font-size: 11px; color: var(--text-dim); font-family: 'Roboto Mono', monospace; margin-bottom: 25px;">> Deixe vazio os campos que o robô deve pular automaticamente.</p>

                            <div id="container-itens"></div>

                            <div class="grid-2" style="margin-top: 25px; padding-top: 20px; border-top: 1px dashed var(--border-glass);">
                                <div class="form-group">
                                    <label><i class="fa-solid fa-paperclip" style="color: var(--alert-red)"></i> DATASHEET (.PDF)</label>
                                    <input type="file" id="res_datasheet" accept=".pdf" multiple onchange="adicionarArquivos(event, 'ds')">
                                    <div id="lista-ds" style="margin-top: 15px;"></div>
                                </div>
                                <div class="form-group">
                                    <label><i class="fa-solid fa-paperclip" style="color: var(--alert-red)"></i> DAV (.PDF)</label>
                                    <input type="file" id="res_dav" accept=".pdf" multiple onchange="adicionarArquivos(event, 'dav')">
                                    <div id="lista-dav" style="margin-top: 15px;"></div>
                                </div>
                            </div>

                            <button type="button" onclick="enviarResposta()" class="btn btn-large btn-respond" style="margin-top: 15px;">
                                <i class="fa-solid fa-server"></i> ENVIAR PARA A FILA
                            </button>
                        </form>
                    </div>
                </div>

                <div id="painel-progresso" class="glass-card" style="display: none; margin-top: 25px;">
                    <h3 class="card-title"><i class="fa-solid fa-network-wired"></i> MONITOR DE PROCESSOS</h3>
                    <div class="status-grid">
                        <div class="status-box">
                            <h4><i class="fa-solid fa-clock"></i> NA FILA</h4>
                            <ul id="lista-pendentes"></ul>
                        </div>
                        <div class="status-box">
                            <h4><i class="fa-solid fa-check-double" style="color: var(--vale-green)"></i> FINALIZADOS</h4>
                            <ul id="lista-concluidos"></ul>
                        </div>
                    </div>
                </div>
                
                <div id="area-captcha" class="glass-card">
                    <h3 class="card-title" style="color: var(--alert-red);"><i class="fa-solid fa-shield-halved"></i> INTERVENÇÃO DE SEGURANÇA</h3>
                    <p style="margin: 0; color: var(--text-main); font-family: 'Roboto Mono', monospace; font-size: 12px; line-height: 1.6;">> O sistema da Vale bloqueou a automação temporariamente. Clique na imagem abaixo para resolver o desafio e liberar o fluxo:</p>
                    <img id="imagem-captcha" src="" alt="Tela Captcha">
                </div>

            </div>
        </div>
    </div>

    <div class="barra-status">
        <div id="indicador-status" class="status-dot offline"></div>
        <span id="log">Conectando ao núcleo maestro...</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        // Opcional: Se quiser manter o fundo animado na tela do Coupa também, basta descomentar abaixo:
        /*
        particlesJS("particles-js", {
            "particles": { "number": { "value": 70 }, "color": { "value": "#ffffff" }, "opacity": { "value": 0.3 }, "size": { "value": 3 }, "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.2, "width": 1 }, "move": { "enable": true, "speed": 1.5 } },
            "interactivity": { "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } } }
        });
        */

        const socket = io();
        socket.emit('sou_frontend'); 
        let arquivosDS = []; let arquivosDAV = [];
        let timerCaptcha; // Variável global para o relógio do Captcha

        // === SINCRONIZAÇÃO DE ESTADO CORRIGIDA ===
        socket.on('sincronizar_estado', function(dados) {
            const estado = dados.estado;
            const msg = dados.mensagem;
            
            const dot = document.getElementById('indicador-status');
            if (estado.status === 'desligado' || !msg) { dot.classList.add('offline'); } 
            else { dot.classList.remove('offline'); }
            
            if (msg) document.getElementById('log').innerText = `> ${msg}`;

            document.getElementById('info-fila').innerText = `${estado.tamanho_fila} Processos`;
            const dataHora = new Date().toLocaleTimeString('pt-BR');
            document.getElementById('info-sync').innerText = `Hoje às ${dataHora}`;

            const painelProgresso = document.getElementById('painel-progresso');
            if (estado.fila_pendente.length > 0 || estado.historico_respondidos.length > 0) {
                painelProgresso.style.display = 'block';
                document.getElementById('lista-pendentes').innerHTML = estado.fila_pendente.map(e => `<li><i class="fa-solid fa-spinner fa-spin" style="color:var(--text-dim)"></i> EVT_${e}</li>`).join('');
                document.getElementById('lista-concluidos').innerHTML = estado.historico_respondidos.map(e => {
                    if(e.includes('Falhou')) return `<li style="color:var(--alert-red)"><i class="fa-solid fa-xmark"></i> ${e}</li>`;
                    return `<li><i class="fa-solid fa-check" style="color:var(--vale-green)"></i> EVT_${e}</li>`;
                }).join('');
            } else { painelProgresso.style.display = 'none'; }

            // LIMPEZA SEGURA DO CAPTCHA (Só limpa se o robô voltar a ficar ocioso ou desligado)
            if (estado.status === 'ocioso' || estado.status === 'desligado') {
                document.getElementById('area-captcha').style.display = 'none';
            }

            const btnLigar = document.getElementById('btn-ligar');
            const txtStatus = document.getElementById('txt-status');
            const overlayLock = document.getElementById('overlay-lock');
            
            const btnExtrair = document.getElementById('btn-extrair');
            const btnVerificar = document.getElementById('btn-verificar');
            const btnAbrirRes = document.getElementById('btn-abrir-res');
            
            // 1. RESETAMOS OS BOTÕES SEMPRE (Garante que eles não fiquem "presos" no botão de Parar)
            btnExtrair.className = 'btn btn-extract';
            btnExtrair.innerHTML = '<i class="fa-solid fa-download"></i> Extrair Cotações';
            btnExtrair.disabled = false;
            btnExtrair.onclick = function() { executarTarefa('extrair'); };

            btnVerificar.className = 'btn btn-verify';
            btnVerificar.innerHTML = '<i class="fa-solid fa-check-double"></i> Verificar Dados';
            btnVerificar.disabled = false;
            btnVerificar.onclick = function() { executarTarefa('verificar'); };

            btnAbrirRes.className = 'btn btn-respond';
            btnAbrirRes.innerHTML = '<i class="fa-solid fa-bolt"></i> Responder Eventos';
            btnAbrirRes.disabled = false;
            btnAbrirRes.onclick = function() { mostrarFormResposta(); };

            if (estado.status === 'desligado') {
                btnLigar.disabled = false; 
                btnLigar.classList.remove('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-power-off"></i> INICIAR SERVIDOR';
                overlayLock.style.opacity = '1';
                overlayLock.style.pointerEvents = 'all';
                overlayLock.innerHTML = '<i class="fa-solid fa-lock"></i><h3>Módulo Bloqueado</h3><p>Aguardando autenticação do servidor...</p>';
            } else if (estado.status === 'logando') {
                btnLigar.disabled = true; 
                btnLigar.classList.remove('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> AUTENTICANDO...';
                overlayLock.innerHTML = '<i class="fa-solid fa-fingerprint fa-bounce" style="color:var(--accent-blue)"></i><h3 style="color:var(--accent-blue)">Autenticando</h3><p>Validando credenciais de acesso...</p>';
            } else {
                btnLigar.disabled = true; 
                btnLigar.classList.add('conectado');
                btnLigar.innerHTML = '<i class="fa-solid fa-link"></i> SISTEMA ONLINE';
                
                overlayLock.style.opacity = '0';
                setTimeout(() => { overlayLock.style.pointerEvents = 'none'; }, 500);
                
                // 2. EXCLUSIVIDADE E TOGGLE CORRIGIDOS (Reconhece o comando do Node.js)
                if (estado.status === 'ocioso') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-terminal"></i> STATUS: AGUARDANDO COMANDOS';
                    txtStatus.style.color = 'var(--vale-green)';
                
                } else if (estado.status === 'extraindo' || estado.status === 'extrair') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> ALGUÉM ESTÁ EXTRAINDO DADOS...';
                    txtStatus.style.color = 'var(--vale-yellow)';
                    
                    // Transforma o botão Extrair no botão PARAR
                    btnExtrair.className = 'btn btn-stop';
                    btnExtrair.innerHTML = '<i class="fa-solid fa-hand"></i> PARAR EXTRAÇÃO';
                    btnExtrair.onclick = function() { solicitarParada(this); };
                    
                    // Trava os demais botões
                    btnVerificar.disabled = true;
                    btnAbrirRes.disabled = true;
                    document.getElementById('area-resposta').style.display = 'none';
                
                } else if (estado.status === 'verificando' || estado.status === 'verificar') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-gear fa-spin"></i> ALGUÉM ESTÁ VERIFICANDO DADOS...';
                    txtStatus.style.color = 'var(--accent-blue)';
                    
                    // Transforma o botão Verificar no botão PARAR
                    btnVerificar.className = 'btn btn-stop';
                    btnVerificar.innerHTML = '<i class="fa-solid fa-hand"></i> PARAR VERIFICAÇÃO';
                    btnVerificar.onclick = function() { solicitarParada(this); };
                    
                    // Trava os demais botões
                    btnExtrair.disabled = true;
                    btnAbrirRes.disabled = true;
                    document.getElementById('area-resposta').style.display = 'none';
                
                } else if (estado.status === 'respondendo') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-database"></i> SISTEMA GRAVANDO RESPOSTAS NA NUVEM...';
                    txtStatus.style.color = 'var(--accent-blue)';
                    
                    btnExtrair.disabled = true;
                    btnVerificar.disabled = true; 
                    // Mantém o de responder aberto caso ele queira adicionar mais na fila
                }
            }
        });

        // === TIMERS E INTELIGÊNCIA DO CAPTCHA ===
        socket.on('nova_imagem', function(dados) { 
            const areaCaptcha = document.getElementById('area-captcha');
            areaCaptcha.style.display = 'block';
            document.getElementById('imagem-captcha').src = "data:image/png;base64," + dados.imagem; 
            
            // Dá um pequeno pulo suave para a pessoa ver que o captcha chegou
            window.scrollTo({ top: areaCaptcha.offsetTop - 20, behavior: 'smooth' });

            // Se em 5 segundos não chegar outra imagem, ele some sozinho
            clearTimeout(timerCaptcha);
            timerCaptcha = setTimeout(() => {
                areaCaptcha.style.display = 'none';
            }, 5000);
        });

        document.getElementById('imagem-captcha').addEventListener('click', function(event) {
            const rect = this.getBoundingClientRect();
            socket.emit('clique_no_captcha', { x: Math.round(event.offsetX * (this.naturalWidth / rect.width)), y: Math.round(event.offsetY * (this.naturalHeight / rect.height)) });
            
            // Bônus UX: Quando o usuário clica, a imagem some instantaneamente para a tela ficar limpa!
            document.getElementById('area-captcha').style.display = 'none';
        });

        function ligarRobo() { socket.emit('comando_direto', { modo: 'ligar_robo' }); }
        function executarTarefa(modo) { socket.emit('comando_direto', { modo: modo }); }
        
        function solicitarParada(btnElement) { 
            socket.emit('comando_direto', { modo: 'solicitar_parada' }); 
            if(btnElement) {
                btnElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> FORÇANDO PARADA...'; 
                btnElement.disabled = true; 
            }
        }
        
        function mostrarFormResposta() { document.getElementById('area-resposta').style.display = 'block'; }

        function gerarCamposItens() {
            const qtd = parseInt(document.getElementById('res_qtd_itens').value) || 1;
            const container = document.getElementById('container-itens');
            container.innerHTML = ''; 
            for(let i=1; i<=qtd; i++) {
                container.innerHTML += `
                    <div class="caixa-item">
                        <span class="caixa-item-titulo">[ ITEM_0${i} ]</span>
                        <div class="grid-2">
                            <div class="form-group" style="margin: 0;">
                                <label>VALOR UNITÁRIO (R$)</label>
                                <input type="text" id="res_preco_${i}" placeholder="0,00">
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>PRAZO (DIAS)</label>
                                <input type="number" id="res_prazo_${i}" placeholder="0">
                            </div>
                        </div>
                    </div>`;
            }
        }

        function adicionarArquivos(event, tipo) {
            const files = event.target.files;
            for(let i = 0; i < files.length; i++) {
                if(tipo === 'ds') arquivosDS.push(files[i]);
                else arquivosDAV.push(files[i]);
            }
            event.target.value = ""; atualizarListasNaTela(tipo);
        }

        function removerArquivo(tipo, index) {
            if(tipo === 'ds') arquivosDS.splice(index, 1);
            else arquivosDAV.splice(index, 1);
            atualizarListasNaTela(tipo);
        }

        function atualizarListasNaTela(tipo) {
            const div = document.getElementById(tipo === 'ds' ? 'lista-ds' : 'lista-dav');
            const lista = tipo === 'ds' ? arquivosDS : arquivosDAV;
            div.innerHTML = "";
            lista.forEach((arquivo, index) => {
                div.innerHTML += `
                    <div class="arquivo-item">
                        <span><i class="fa-regular fa-file" style="color:var(--text-dim);"></i> ${arquivo.name}</span> 
                        <button type="button" class="btn-remover" onclick="removerArquivo('${tipo}', ${index})"><i class="fa-solid fa-xmark"></i></button>
                    </div>`;
            });
        }

        async function enviarResposta() {
            const campoEventos = document.getElementById('res_evento').value;
            if(!campoEventos) { alert("INFORME O NÚMERO DO EVENTO!"); return; }

            const listaEventos = campoEventos.split(',').map(e => e.trim()).filter(e => e !== "");
            const qtd = parseInt(document.getElementById('res_qtd_itens').value) || 1;
            let precos = []; let prazos = [];
            
            for(let i=1; i<=qtd; i++) {
                precos.push(document.getElementById(`res_preco_${i}`).value);
                prazos.push(document.getElementById(`res_prazo_${i}`).value);
            }

            const btnEnviar = document.querySelector('button[onclick="enviarResposta()"]');
            const textoOriginal = btnEnviar.innerHTML;
            btnEnviar.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> TRANSMITINDO PACOTES...';
            btnEnviar.disabled = true;

            for (const eventoId of listaEventos) {
                const formData = new FormData();
                formData.append('evento', eventoId);
                formData.append('precos', JSON.stringify(precos));
                formData.append('prazos', JSON.stringify(prazos));
                for(let i=0; i < arquivosDS.length; i++) { formData.append('datasheet', arquivosDS[i]); }
                for(let i=0; i < arquivosDAV.length; i++) { formData.append('dav', arquivosDAV[i]); }

                try { await fetch('/api/responder', { method: 'POST', body: formData }); } 
                catch(err) { console.error("Falha ao transmitir o evento: " + eventoId); }
            }

            btnEnviar.innerHTML = textoOriginal;
            btnEnviar.disabled = false;
            document.getElementById('area-resposta').style.display = 'none';
            document.getElementById('res_evento').value = '';
            arquivosDS = []; arquivosDAV = [];
            atualizarListasNaTela('ds'); atualizarListasNaTela('dav');
            window.scrollTo({ top: document.getElementById('painel-progresso').offsetTop - 20, behavior: 'smooth' });
        }
    </script>
</body>
</html>
