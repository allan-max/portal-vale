<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Robô Coupa (Enterprise)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --border-color: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --success: #10b981;
            --success-hover: #059669;
            --warning: #f59e0b;
            --warning-hover: #d97706;
            --danger: #ef4444;
            --danger-hover: #dc2626;
            --purple: #8b5cf6;
            --purple-hover: #7c3aed;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 40px 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 28px; font-weight: 700; margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .header h1 i { color: var(--primary); }
        
        .badge { background: var(--warning); color: #fff; padding: 4px 12px; border-radius: 999px; font-size: 14px; font-weight: 700; display: none; margin-left: 10px; box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }

        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Botões */
        .btn { padding: 12px 20px; font-size: 15px; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-family: 'Inter', sans-serif; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        .btn-large { width: 100%; font-size: 18px; padding: 16px; margin-bottom: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        
        .botoes-acao { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }

        /* Formulários */
        .form-container { display: none; margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--border-color); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-muted); font-size: 14px; }
        .form-group input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-body); color: white; font-size: 14px; box-sizing: border-box; outline: none; transition: 0.2s; font-family: 'Inter', sans-serif;}
        .form-group input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        .caixa-item { background: rgba(15, 23, 42, 0.5); border: 1px dashed var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .caixa-item-titulo { color: var(--success); font-weight: 600; margin-bottom: 10px; display: block;}

        /* Inputs de Arquivo Customizados */
        input[type=file]::file-selector-button { border: none; background: var(--border-color); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 15px; transition: 0.2s; font-weight: 500;}
        input[type=file]::file-selector-button:hover { background: #475569; }
        
        .arquivo-item { background: var(--bg-body); padding: 8px 12px; margin: 8px 0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; border: 1px solid var(--border-color); }
        .btn-remover { background: transparent; border: none; color: var(--danger); cursor: pointer; font-size: 16px; padding: 0 5px; }
        .btn-remover:hover { color: var(--danger-hover); }

        /* Terminal Log */
        .terminal { background: #000; border-radius: 8px; padding: 0; overflow: hidden; border: 1px solid #333; margin-top: 20px;}
        .terminal-header { background: #333; padding: 8px 15px; display: flex; gap: 6px; align-items: center;}
        .dot { width: 12px; height: 12px; border-radius: 50%; }
        .dot.red { background: #ff5f56; } .dot.yellow { background: #ffbd2e; } .dot.green { background: #27c93f; }
        #log { padding: 15px; font-family: 'Courier New', Courier, monospace; color: #00ff00; font-size: 14px; text-align: left; margin: 0;}

        /* Painel de Progresso */
        #painel-progresso { display: none; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px; }
        .status-box { background: var(--bg-body); border-radius: 8px; padding: 15px; border: 1px solid var(--border-color); text-align: left;}
        .status-box h4 { margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px; }
        .status-box ul { list-style: none; padding: 0; margin: 0; }
        .status-box ul li { padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 14px; display: flex; align-items: center; gap: 8px;}
        .status-box ul li:last-child { border-bottom: none; }

        /* Captcha */
        #area-captcha { display: none; border-color: var(--danger); }
        #imagem-captcha { border-radius: 8px; cursor: crosshair; max-width: 100%; border: 2px dashed var(--danger); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body onload="gerarCamposItens()">

    <div class="container">
        
        <div class="header">
            <h1><i class="fa-solid fa-robot"></i> Terminal Coupa ERP <span id="badge-fila" class="badge">Fila: 0</span></h1>
            <p style="color: var(--text-muted); margin-top: 5px;">Sistema Automático de Leitura e Resposta</p>
        </div>

        <button id="btn-ligar" onclick="ligarRobo()" class="btn btn-large btn-warning">
            <i class="fa-solid fa-power-off"></i> Iniciar Servidor (Login Automático)
        </button>
        
        <div id="painel-tarefas" class="card" style="display: none;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 id="txt-status" style="margin: 0; color: var(--success);"><i class="fa-solid fa-circle-check"></i> Robô Livre! Escolha uma ação abaixo:</h3>
            </div>
            
            <div class="botoes-acao">
                <button id="btn-extrair" onclick="executarTarefa('extrair')" class="btn btn-success"><i class="fa-solid fa-download"></i> Tirar Eventos</button>
                <button id="btn-verificar" onclick="executarTarefa('verificar')" class="btn btn-primary"><i class="fa-solid fa-list-check"></i> Verificar Respostas</button>
                <button id="btn-abrir-res" onclick="mostrarFormResposta()" class="btn btn-purple"><i class="fa-solid fa-upload"></i> Responder Evento</button>
            </div>
            
            <button id="btn-parar" onclick="solicitarParada()" class="btn btn-danger" style="display: none; width: 100%; margin-top: 15px;">
                <i class="fa-solid fa-hand"></i> PARAR AÇÃO ATUAL (Salvar e Fechar)
            </button>
            
            <div id="area-resposta" class="form-container">
                <h3 style="margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;"><i class="fa-solid fa-pen-to-square"></i> Preencher Resposta</h3>
                
                <form id="formResponder">
                    <div class="grid-2">
                        <div class="form-group">
                            <label><i class="fa-solid fa-hashtag"></i> Número do Evento:</label>
                            <input type="text" id="res_evento" required placeholder="Ex: 165060">
                        </div>
                        <div class="form-group">
                            <label><i class="fa-solid fa-boxes-stacked"></i> Qtd. Total de Itens no Evento:</label>
                            <input type="number" id="res_qtd_itens" min="1" value="1" required onchange="gerarCamposItens()">
                        </div>
                    </div>
                    
                    <p style="font-size: 12px; color: var(--warning); text-align: left;"><i class="fa-solid fa-circle-info"></i> Dica: Deixe os campos em branco nos itens que você NÃO quer responder.</p>

                    <div id="container-itens"></div>

                    <div class="grid-2" style="margin-top: 20px; align-items: start;">
                        <div class="form-group">
                            <label><i class="fa-solid fa-file-pdf"></i> Anexar Datasheet(s):</label>
                            <input type="file" id="res_datasheet" accept=".pdf" multiple onchange="adicionarArquivos(event, 'ds')">
                            <div id="lista-ds" style="margin-top: 10px;"></div>
                        </div>
                        <div class="form-group">
                            <label><i class="fa-solid fa-file-pdf"></i> Anexar DAV(s):</label>
                            <input type="file" id="res_dav" accept=".pdf" multiple onchange="adicionarArquivos(event, 'dav')">
                            <div id="lista-dav" style="margin-top: 10px;"></div>
                        </div>
                    </div>

                    <button type="button" onclick="enviarResposta()" class="btn btn-large btn-purple" style="margin-top: 15px; margin-bottom: 0;">
                        <i class="fa-solid fa-paper-plane"></i> Mandar para a Fila do Robô
                    </button>
                </form>
            </div>
        </div>

        <div id="painel-progresso" class="card">
            <h3 style="margin: 0; text-align: left;"><i class="fa-solid fa-chart-line"></i> Status da Fila de Respostas</h3>
            <div class="status-grid">
                <div class="status-box">
                    <h4 style="color: var(--warning);"><i class="fa-solid fa-hourglass-half"></i> Na Fila (Aguardando)</h4>
                    <ul id="lista-pendentes"></ul>
                </div>
                <div class="status-box">
                    <h4 style="color: var(--success);"><i class="fa-solid fa-check-double"></i> Já Respondidos</h4>
                    <ul id="lista-concluidos"></ul>
                </div>
            </div>
        </div>
        
        <div id="area-captcha" class="card">
            <h3 style="margin-top: 0; color: var(--danger);"><i class="fa-solid fa-triangle-exclamation"></i> Intervenção Manual Necessária</h3>
            <p style="margin: 0; color: var(--text-muted);">O sistema da Vale exigiu verificação. Clique na imagem abaixo no local correto para liberar o robô:</p>
            <img id="imagem-captcha" src="" alt="Tela Captcha">
        </div>

        <div class="terminal">
            <div class="terminal-header">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
                <span style="margin-left: 10px; font-size: 12px; color: #888; font-family: monospace;">bash - log_do_robo</span>
            </div>
            <p id="log">> Sincronizando com o servidor principal...</p>
        </div>
    </div>

    <script>
        const socket = io();
        socket.emit('sou_frontend'); // Avisa o servidor que isto é uma página de um utilizador
        let arquivosDS = []; let arquivosDAV = [];

        // === SINCRONIZAÇÃO EM TEMPO REAL ===
        socket.on('sincronizar_estado', function(dados) {
            const estado = dados.estado;
            const msg = dados.mensagem;
            
            if (msg) document.getElementById('log').innerText = "> " + msg;

            // Fila de Respostas
            const badgeFila = document.getElementById('badge-fila');
            if (estado.tamanho_fila > 0) {
                badgeFila.style.display = 'inline-block';
                badgeFila.innerText = "Fila: " + estado.tamanho_fila;
            } else { badgeFila.style.display = 'none'; }

            // Lógica do Painel de Progresso
            const painelProgresso = document.getElementById('painel-progresso');
            if (estado.fila_pendente.length > 0 || estado.historico_respondidos.length > 0) {
                painelProgresso.style.display = 'block';
                document.getElementById('lista-pendentes').innerHTML = estado.fila_pendente.map(e => `<li><i class="fa-solid fa-spinner fa-spin" style="color:var(--warning)"></i> Evento ${e}</li>`).join('');
                document.getElementById('lista-concluidos').innerHTML = estado.historico_respondidos.map(e => `<li><i class="fa-solid fa-check" style="color:var(--success)"></i> Evento ${e}</li>`).join('');
            } else {
                painelProgresso.style.display = 'none';
            }

            if (estado.status !== 'logando') { document.getElementById('area-captcha').style.display = 'none'; }

            const btnLigar = document.getElementById('btn-ligar');
            const painelTarefas = document.getElementById('painel-tarefas');
            
            if (estado.status === 'desligado') {
                btnLigar.style.display = 'inline-block';
                btnLigar.disabled = false; btnLigar.innerHTML = '<i class="fa-solid fa-power-off"></i> Iniciar Servidor (Login Automático)';
                painelTarefas.style.display = 'none';
            } else if (estado.status === 'logando') {
                btnLigar.disabled = true; btnLigar.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sessão Aberta. Logando...';
            } else {
                btnLigar.style.display = 'none';
                painelTarefas.style.display = 'block';
                
                const btnExtrair = document.getElementById('btn-extrair');
                const btnVerificar = document.getElementById('btn-verificar');
                const btnAbrirRes = document.getElementById('btn-abrir-res');
                const btnParar = document.getElementById('btn-parar');
                const txtStatus = document.getElementById('txt-status');

                if (estado.status === 'ocioso') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-circle-check"></i> Robô Livre! Escolha uma ação abaixo:';
                    txtStatus.style.color = 'var(--success)';
                    btnExtrair.disabled = false; btnVerificar.disabled = false; btnAbrirRes.disabled = false;
                    btnParar.style.display = 'none';
                } else if (estado.status === 'extraindo' || estado.status === 'verificando') {
                    txtStatus.innerHTML = `<i class="fa-solid fa-gears fa-spin"></i> O Robô está ocupado no momento: ${estado.status.toUpperCase()}`;
                    txtStatus.style.color = 'var(--warning)';
                    btnExtrair.disabled = true; btnVerificar.disabled = true; btnAbrirRes.disabled = true;
                    btnParar.style.display = 'inline-block'; 
                    document.getElementById('area-resposta').style.display = 'none';
                } else if (estado.status === 'respondendo') {
                    txtStatus.innerHTML = '<i class="fa-solid fa-layer-group"></i> Robô processando Fila de Respostas. Pode enviar mais!';
                    txtStatus.style.color = 'var(--purple)';
                    btnExtrair.disabled = true; btnVerificar.disabled = true; 
                    btnAbrirRes.disabled = false; 
                    btnParar.style.display = 'none'; 
                }
            }
        });

        // REVELA O CAPTCHA
        socket.on('nova_imagem', function(dados) { 
            document.getElementById('area-captcha').style.display = 'block';
            document.getElementById('imagem-captcha').src = "data:image/png;base64," + dados.imagem; 
        });

        document.getElementById('imagem-captcha').addEventListener('click', function(event) {
            const rect = this.getBoundingClientRect();
            socket.emit('clique_no_captcha', { x: Math.round(event.offsetX * (this.naturalWidth / rect.width)), y: Math.round(event.offsetY * (this.naturalHeight / rect.height)) });
        });

        // === FUNÇÕES DE AÇÃO ATUALIZADAS PARA A NUVEM ===
        function ligarRobo() { socket.emit('comando_direto', { modo: 'ligar_robo' }); }
        function executarTarefa(modo) { socket.emit('comando_direto', { modo: modo }); }
        function solicitarParada() { 
            socket.emit('comando_direto', { modo: 'solicitar_parada' }); 
            document.getElementById('btn-parar').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Aguarde... Encerrando e Salvando Lote!'; 
            document.getElementById('btn-parar').disabled = true; 
        }
        function mostrarFormResposta() { document.getElementById('area-resposta').style.display = 'block'; }

        function gerarCamposItens() {
            const qtd = parseInt(document.getElementById('res_qtd_itens').value) || 1;
            const container = document.getElementById('container-itens');
            container.innerHTML = ''; 
            for(let i=1; i<=qtd; i++) {
                container.innerHTML += `
                    <div class="caixa-item">
                        <span class="caixa-item-titulo"><i class="fa-solid fa-box-open"></i> Item ${i}</span>
                        <div class="grid-2">
                            <div class="form-group" style="margin: 0;"><input type="text" id="res_preco_${i}" placeholder="Preço (Vazio para pular)"></div>
                            <div class="form-group" style="margin: 0;"><input type="number" id="res_prazo_${i}" placeholder="Prazo (Vazio para pular)"></div>
                        </div>
                    </div>`;
            }
        }

        function adicionarArquivos(event, tipo) {
            const files = event.target.files;
            for(let i = 0; i < files.length; i++) {
                if(tipo === 'ds') arquivosDS.push(files[i]);
                else arquivosDAV.push(files[i]);
            }
            event.target.value = ""; atualizarListasNaTela(tipo);
        }

        function removerArquivo(tipo, index) {
            if(tipo === 'ds') arquivosDS.splice(index, 1);
            else arquivosDAV.splice(index, 1);
            atualizarListasNaTela(tipo);
        }

        function atualizarListasNaTela(tipo) {
            const div = document.getElementById(tipo === 'ds' ? 'lista-ds' : 'lista-dav');
            const lista = tipo === 'ds' ? arquivosDS : arquivosDAV;
            div.innerHTML = "";
            lista.forEach((arquivo, index) => {
                div.innerHTML += `<div class="arquivo-item"><span><i class="fa-regular fa-file-pdf" style="color:var(--danger)"></i> ${arquivo.name}</span> <button type="button" class="btn-remover" onclick="removerArquivo('${tipo}', ${index})"><i class="fa-solid fa-xmark"></i></button></div>`;
            });
        }

        function enviarResposta() {
            const eventoId = document.getElementById('res_evento').value;
            if(!eventoId) { alert("Preencha o número do evento!"); return; }

            const formData = new FormData();
            formData.append('evento', eventoId);
            const qtd = parseInt(document.getElementById('res_qtd_itens').value) || 1;
            let precos = []; let prazos = [];
            
            for(let i=1; i<=qtd; i++) {
                precos.push(document.getElementById(`res_preco_${i}`).value);
                prazos.push(document.getElementById(`res_prazo_${i}`).value);
            }
            formData.append('precos', JSON.stringify(precos));
            formData.append('prazos', JSON.stringify(prazos));

            for(let i=0; i < arquivosDS.length; i++) { formData.append('datasheet', arquivosDS[i]); }
            for(let i=0; i < arquivosDAV.length; i++) { formData.append('dav', arquivosDAV[i]); }

            fetch('/api/responder', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if(data.status === "sucesso") {
                    document.getElementById('area-resposta').style.display = 'none';
                    document.getElementById('res_evento').value = '';
                    arquivosDS = []; arquivosDAV = [];
                    atualizarListasNaTela('ds'); atualizarListasNaTela('dav');
                    
                    // Rola a tela pra cima suavemente para ver o painel de fila
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else { alert("Erro: " + data.mensagem); }
            });
        }
    </script>
</body>
</html>